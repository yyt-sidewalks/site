<!DOCTYPE html>
	<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta property="og:url" content="https://yyt-sidewalks.github.io/site/" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="Sidewalks in St John's, NL" />
		<meta property="og:description" content="A site for tracking sidewalk and pedestrian safety and usage in St. John's, NL" />
		<title>YYT Sidewalks - Stories</title>
		<link rel="stylesheet" href="../css/main.css">
		<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<!--leaflet-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
<!--Location Plugin-->
<script src='https://cdn.jsdelivr.net/leaflet.locatecontrol/0.49.0/L.Control.Locate.min.js'></script>
<link href='https://cdn.jsdelivr.net/leaflet.locatecontrol/0.49.0/L.Control.Locate.css' rel='stylesheet' />
<!--Tabletop and GeoJson-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js"></script>
<script src="../lib/geojson.js"></script>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	</head>
	<body>
		<nav class="navbar">
			<div class="container is-fluid">
				<div class="navbar-brand">
					<a class="navbar-item" href="https://yyt-sidewalks.github.io/site">
						<img src="../images/icons/001-crossing.png" alt="Sidewalks in St. John's, NL" height="28">
					</a>
					<div class="navbar-burger burger" data-target="navbar">
						<span></span>
						<span></span>
						<span></span>
					</div>
				</div>
				<div id="navbar" class="navbar-menu">
					<div class="navbar-start">
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site">Home</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/about/">About</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/stories/">Stories</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/priorities/">Priorities</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/obstructions/">Obstructions</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/data/">Data</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/Resources/">Resources</a>
					</div>
				</div>
			</div>
		</nav>
		<section id="main" class="section">
			<div class="container is-fluid">
				<div class="content">
					<div class="title is-size-2 is-size-4-touch">Data</div>
					<div class="subtitle is-size-6-touch">Data on the City of St. John's</div>
					<div id="controls">
						<h4 class="is-size-4">2016 Census Data</h4>
						<div class="field is-grouped">
							<div class="control">
								<div class="select">
									<select id="censusdata">
										<option value="">Select Variable</option>
										<option value="percentages.walked.all">Commuters: % walk</option>
										<option value="percentages.transit.all">Commuters: % take transit</option>
										<option value="income.all">After-Tax Income</option>
										<option value="population.density">Population Density</option>
									</select>
								</div>
							</div>
							<div class="control">
								<button id="resetareas" class="button is-primary">Reset</button>
							</div>
						</div>
						<div class="field">
							<button class="button is-primary" id="zoommap">Zoom</button>
							<button class="button is-primary" id="shrinkmap"><i class="fas fa-times"></i></button>
						</div>
					</div>
				</div>
				<div class="content">
					<div class="map">
						<div id="map"></div>
					</div>
				</div>
				<div class="content">
					<div id="blurb">
						<h3 class="is-size-3">About this page</h3>
						<p>The data on this page is drawn from the 2016 Canadian Census, as available from <a href="http://www.censusmapper.ca" target="_blank">www.censusmapper.ca</a>. It's been processed slightly to obtain a few variables, based on income and population density.</p>
						<h4 class="is-size-4">How to use this page</h4>
						<p>Select a variable to view the statistics for:</p>
						<ul>
							<li>Percentage of Commuters who walk to work</li>
							<li>Percentage of Commuters who take public transit to work</li>
							<li>After-tax income divided into ten quantiles (decile) or ranges from high to low</li>
							<li>Population density per square kilometer divided into ten quantiles (decile) or ranges from high to low</li>
						</ul>
					</div>
				</div>
			</div>
		</section>
	<footer class="footer has-text-centered">
		<div class="container is-fluid">
			<div class="columns">
				<div class="column is-8-desktop is-offset-2-desktop">
					<p>
						<small>
						Source code licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>
						</small>
					</p>
					<p style="margin-top: 1rem;">
						<a href="http://bulma.io">
						<img src="../made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
						</a>
					</p>
				</div>
			</div>
		</div>
	</footer>
	<script type="text/javascript" src="../lib/main.js"></script>
	<script>
		var censusdata;
		var censusareas={};
		var layertoggles={},centretoggle=false;
		var gradient=["#168900","#2c7c00","#416f00","#576200","#6d5500","#834900","#993c00","#af2f00","#c42200","#da1500"];
		var alllayers={};
		var map = L.map('map',{zoomControl: false}).setView([47.5670, -52.7292], 14); //Initialize the map
		new L.Control.Zoom({ position: 'bottomleft' }).addTo(map);
		//Add a basemap
		var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		}).addTo(map);
		$.ajax({
			dataType: "json",
			url: "demographics.json",
			success: function(data) {
				censusdata=data;
				buildcensusdata();
			}
		});
		var censuslayer = new L.geoJson(null,{
			style: function(geoJsonFeature){
				return {fillColor: 'transparent', color:'none', weight: '0', fillOpacity: 0.2}
			},
			onEachFeature: function(feature, layer){
				censusareas[feature.properties.id] = layer;
			}
		});
		censuslayer.addTo(map);
		alllayers['census']=censuslayer;
		layertoggles['census']=false;
		$.ajax({
			dataType: "json",
			url: "censuszones.json",
			success: function(data) {
				$(data.features).each(function(key, data) {
					censuslayer.addData(data);
				});
			}
		});
		var schoolicon = new L.Icon({
			iconSize: [27, 27],
			iconAnchor: [13, 27],
			popupAnchor:  [1, -24],
			iconUrl: '../images/icons/school.png'
		});
		var schoollayer = new L.geoJson(null,{
			style: function(feature){
				if(feature.geometry.type === 'Polygon') {
					return {fillColor: '#cc9a10', color:'none', weight: '0', fillOpacity: 0.3}
				}
			},
			pointToLayer: function(feature, latlng) {
				if(feature.geometry.type === 'Point') {
					return L.marker(latlng, {icon: schoolicon});
				}
			}
		});
		schoollayer.addTo(map);
		alllayers['schools']=schoollayer;
		layertoggles['schools']=false;
		$.ajax({
			dataType: "json",
			url: "schools.json",
			success: function(data) {
				$(data.features).each(function(key, data) {
					schoollayer.addData(data);
				});
			}
		});
		var hospitalicon = new L.Icon({
			iconSize: [27, 27],
			iconAnchor: [13, 27],
			popupAnchor:  [1, -24],
			iconUrl: '../images/icons/hospital.png'
		});
		var hospitallayer = new L.geoJson(null,{
			style: function(feature){
				if(feature.geometry.type === 'Polygon') {
					return {fillColor: '#0a7ed1', color:'none', weight: '0', fillOpacity: 0.3}
				}
			},
			pointToLayer: function(feature, latlng) {
				if(feature.geometry.type === 'Point') {
					return L.marker(latlng, {icon: hospitalicon});
				}
			}
		});
		hospitallayer.addTo(map);
		alllayers['hospitals']=hospitallayer;
		layertoggles['hospitals']=false;
		$.ajax({
			dataType: "json",
			url: "hospitals.json",
			success: function(data) {
				$(data.features).each(function(key, data) {
					hospitallayer.addData(data);
				});
			}
		});
		$(function() {
			$('#censusdata').change(function(){
				updateareas($(this).val());
			});
			$('#resetareas').click(function(){
				$('#censusdata').val('');
				resetareas();
			});
			$('.datatoggle').click(function(){
				togglelayers($(this).data('layer'));
			});
			togglelayers('centres');
			setTimeout(function() {
				updateareas('percentages.walked.all');
				$('#censusdata').val('percentages.walked.all');
			}, 1500);
		});
		function buildcensusdata(){
			censusdata.averages={};
			censusdata.totals={};
			censusdata.values={};
			censusdata.max={};
			censusdata.min={};
			censusdata.totals.afterTaxIncome=0;
			censusdata.values.afterTaxIncome=[];
			censusdata.max.afterTaxIncome=0;
			censusdata.min.afterTaxIncome=0;
			censusdata.values.density=[];
			censusdata.max.density=0;
			censusdata.min.density=0;
			censusdata.ranges={};
			censusdata.ranges.afterTaxIncome=[0];
			censusdata.ranges.density=[0];
			censusdata.tiers={};
			censusdata.tiers.afterTaxIncome=0;
			censusdata.tiers.density=0;
			var hasAfterTaxIncome=0;
			$.each(censusdata,function(k,v){
				censusdata[k].density=Math.ceil(parseInt(v.Population)*(1/parseFloat(v['Area (sq km)'])));
				censusdata.values.density.push(censusdata[k].density);
				censusdata[k].percentages={};
				censusdata[k].percentages.walked={};
				if(parseInt(v.Data.v_CA16_5792.value)){
					censusdata[k].percentages.walked.all=parseInt(v.Data.v_CA16_5804.value)/parseInt(v.Data.v_CA16_5792.value);
				}else{
					censusdata[k].percentages.walked.all=0;
				}
				if(parseInt(v.Data.v_CA16_5794.value)){
					censusdata[k].percentages.walked.female=parseInt(v.Data.v_CA16_5806.value)/parseInt(v.Data.v_CA16_5794.value);
				}else{
					censusdata[k].percentages.walked.female=0;
				}
				if(parseInt(v.Data.v_CA16_5793.value)){
					censusdata[k].percentages.walked.male=parseInt(v.Data.v_CA16_5805.value)/parseInt(v.Data.v_CA16_5793.value);
				}else{
					censusdata[k].percentages.walked.male=0;
				}
				censusdata[k].percentages.transit={};
				if(parseInt(v.Data.v_CA16_5792.value)){
					censusdata[k].percentages.transit.all=parseInt(v.Data.v_CA16_5801.value)/parseInt(v.Data.v_CA16_5792.value);
				}else{
					censusdata[k].percentages.transit.all=0;
				}
				if(parseInt(v.Data.v_CA16_5794.value)){
					censusdata[k].percentages.transit.female=parseInt(v.Data.v_CA16_5803.value)/parseInt(v.Data.v_CA16_5794.value);
				}else{
					censusdata[k].percentages.transit.female=0;
				}
				if(parseInt(v.Data.v_CA16_5793.value)){
					censusdata[k].percentages.transit.male=parseInt(v.Data.v_CA16_5802.value)/parseInt(v.Data.v_CA16_5793.value);
				}else{
					censusdata[k].percentages.transit.male=0;
				}
				if(parseInt(v.Data.v_CA16_4963.value)!==false){
					censusdata.totals.afterTaxIncome=censusdata.totals.afterTaxIncome+parseInt(v.Data.v_CA16_4963.value);
					hasAfterTaxIncome++;
					censusdata.values.afterTaxIncome.push(parseInt(v.Data.v_CA16_4963.value));
				}
			});
			censusdata.averages.afterTaxIncome=Math.ceil(censusdata.totals.afterTaxIncome/hasAfterTaxIncome);
			censusdata.max.afterTaxIncome=Math.max.apply(Math,censusdata.values.afterTaxIncome);
			censusdata.min.afterTaxIncome=Math.min.apply(Math,censusdata.values.afterTaxIncome);
			censusdata.tiers.afterTaxIncome=Math.ceil(censusdata.max.afterTaxIncome/gradient.length);
			censusdata.max.density=Math.max.apply(Math,censusdata.values.density);
			censusdata.min.density=Math.min.apply(Math,censusdata.values.density);
			censusdata.tiers.density=Math.ceil(censusdata.max.density/gradient.length);
			//calculate tiers for gradients
			$.each(gradient,function(k,v){
				if(k){
					var lastkey=k-1;
					censusdata.ranges.afterTaxIncome.push(censusdata.tiers.afterTaxIncome+censusdata.ranges.afterTaxIncome[lastkey]);
					censusdata.ranges.density.push(censusdata.tiers.density+censusdata.ranges.density[lastkey]);
				}
			});
		}
		function updateareas(e){
			resetareas();
			switch(e){
				case "percentages.walked.all":
					$.each(censusdata,function(k,v){
						var rounded=Math.ceil(Math.round(v.percentages.walked.all*100)/10);
						var opacity=(Math.round(v.percentages.walked.all*10)/10)*1.75;
						censusareas[v.GeoUID].setStyle({fillColor:gradient[rounded],fillOpacity: opacity});
					});
				break;
				case "percentages.transit.all":
					$.each(censusdata,function(k,v){
						var rounded=Math.ceil(Math.round(v.percentages.transit.all*100)/10);
						var opacity=(Math.round(v.percentages.transit.all*10)/10)*1.75;
						censusareas[v.GeoUID].setStyle({fillColor:gradient[rounded],fillOpacity: opacity});
					});
				break;
				case "income.all":
					$.each(censusdata,function(k,v){
						var rounded=Math.round(v.Data.v_CA16_4963.value/censusdata.tiers.afterTaxIncome);
						var opacity=0.6;
						censusareas[v.GeoUID].setStyle({fillColor:gradient[rounded],fillOpacity: opacity});
					});
				break;
				case "population.density":
					$.each(censusdata,function(k,v){
						var rounded=Math.round(v.density/censusdata.tiers.density);
						var opacity=0.6;
						censusareas[v.GeoUID].setStyle({fillColor:gradient[rounded],fillOpacity: opacity});
					});
				break;
			}
		}
		function resetareas(){
			$.each(censusareas,function(k,v){
				censusareas[k].setStyle({fillColor: 'transparent', color:'none', weight: '0', fillOpacity: 0.2});
			});
		}
		function togglelayers(l) {
			if(l=="centres"){
				if(!centretoggle){
					$.each(layertoggles,function(k,v){
						if(!v && (k=='schools' || k=='hospitals')){
							map.removeLayer(alllayers[k]);
							layertoggles[k] = !layertoggles[k];
							$('#'+k+'ctl').text('show');
						}
					});
					$('#centresctl').text('show');
				} else {
					$.each(layertoggles,function(k,v){
						if(v && (k=='schools' || k=='hospitals')){
							map.addLayer(alllayers[k]);
							layertoggles[k] = !layertoggles[k];
							$('#'+k+'ctl').text('hide');
						}
					});
					$('#centresctl').text('hide');
				}
				centretoggle = !centretoggle;
			}else{
				if(!layertoggles[l]){
					map.removeLayer(alllayers[l]);
					$('#'+l+'ctl').text('show');
				} else {
					map.addLayer(alllayers[l]);
					$('#'+l+'ctl').text('hide');
				}
				layertoggles[l] = !layertoggles[l];
			}
		}
	</script>
	<link rel="stylesheet" href="../css/leaflet.css">
	</body>
</html>
