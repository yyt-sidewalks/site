<!DOCTYPE html>
	<html>
	  <head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta property="og:url" content="https://yyt-sidewalks.github.io/site/" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="Sidewalks in St John's, NL" />
		<meta property="og:description" content="A site for tracking sidewalk and pedestrian safety and usage in St. John's, NL" />
		<title>YYT Sidewalks - Stories</title>
		<link rel="stylesheet" href="css/main.css">
		<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
		<!--leaflet-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
<!--Location Plugin-->
<script src='https://cdn.jsdelivr.net/leaflet.locatecontrol/0.49.0/L.Control.Locate.min.js'></script>
<link href='https://cdn.jsdelivr.net/leaflet.locatecontrol/0.49.0/L.Control.Locate.css' rel='stylesheet' />
<!--Tabletop and GeoJson-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js"></script>
<script src="lib/geojson.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	</head>
	<body>
		<nav class="navbar">
			<div class="container is-fluid">
				<div class="navbar-brand">
					<a class="navbar-item" href="https://yyt-sidewalks.github.io/site">
						<img src="images/icons/001-crossing.png" alt="Sidewalks in St. John's, NL" height="28">
					</a>
					<div class="navbar-burger burger" data-target="navbar">
						<span></span>
						<span></span>
						<span></span>
					</div>
				</div>
				<div id="navbar" class="navbar-menu">
					<div class="navbar-start">
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site">Home</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/about/">About</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/stories/">Stories</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/priorities/">Priorities</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/obstructions/">Obstructions</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/data/">Data</a>
						<a class="navbar-item" href="https://yyt-sidewalks.github.io/site/Resources/">Resources</a>
					</div>
				</div>
			</div>
		</nav>
		<section id="main" class="section">
			<div class="container is-fluid">
				<div class="content">
					<div class="title is-size-2 is-size-4-touch">Sidewalks & Pedestrian Safety in St. John's, NL</div>
					<div class="subtitle is-size-6-tablet is-hidden-mobile">Items that are embedded within or obstruct easy movement within sidewalks.</div>
				</div>
				<div class="content">
					<div id="controls">
						<button class="button is-primary" id="zoommap">Zoom</button>
						<span id="zoomcontrols">
							<button class="button is-primary datatoggle" id="showpriorities" data-layer="priorities"><span class="is-hidden-touch">City Snow&nbsp;</span>Priorities</button>
							<button class="button is-primary datatoggle" id="showstories" data-layer="stories">Stories</button>
							<button class="button is-primary datatoggle" id="showschools" data-layer="schools">Schools</button>
							<button class="button is-primary datatoggle" id="showhospitals" data-layer="hospitals">Hospitals<span class="is-hidden-touch">&nbsp;& Clinics</span></button>
							<button class="button is-primary datatoggle" id="showwalkers" data-layer="census">Walking<span class="is-hidden-touch">&nbsp;Commuters</span></button>
							<button class="button is-primary datatoggle" id="showobstructions" data-layer="obstructions">Obstructions</button>
						</span>
						<button class="button is-primary" id="shrinkmap"><i class="fas fa-times"></i></button>
					</div>
				</div>
				<div class="content">
					<div class="map">
						<div id="map"></div>
					</div>
				</div>
				<div class="content">
					<h3 class="is-size-3">Sidewalk Stories</h3>
					<div id="stories" class="columns">
						
					</div>
				</div>
				<div class="content">
					<div id="blurb">
						<h3 class="is-size-3">What we're doing</h3>
						<p>Getting around St. John's, NL, on foot on the sidewalks is can be pretty tricky - from vehicles that won't stop at crosswalks, to clearing snow, and obstructions in the sidewalk itself, it's not really a cake walk. And so, we're trying to pull all of the information we can get together in one place. We're hoping it will help City Council and those who keep an eye on them - you, the voters - informed about what's going on, and how we could do better to foster safe walking for all.</p>
						<p>All of the data used on this website is open access, as is the code. For more information, see the About page.</p>
						<h4 class="is-size-4">How to use this site</h4>
						<p>This site is designed to act as a resource, and a tool for collecting data regarding pedestrian safety, and sidewalk access in the City of St. John's, NL. You can add points on the obstructions and stories maps, or review data from open sources that describes our city, residents, and its neighbourhoods.</p>
					</div>
				</div>
			</div>
		</section>
		<footer class="footer has-text-centered">
			<div class="container is-fluid">
				<div class="columns">
					<div class="column is-8-desktop is-offset-2-desktop">
						<p>
							<small>
							Source code licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>
							</small>
						</p>
						<p style="margin-top: 1rem;">
							<a href="http://bulma.io">
							<img src="made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
							</a>
						</p>
					</div>
				</div>
			</div>
		</footer>
		<script type="text/javascript" src="lib/main.js"></script>
		<script>
			var storysharedgsheet ='https://docs.google.com/spreadsheets/d/1C9vcW_ystvMG-7l-2cJB4JQ2XBlCt7I3GSK9F3wp2-E/edit?usp=sharing';
			var activestories=[];
			var storydetails = Tabletop.init( {
				key: storysharedgsheet,
				simpleSheet: true,
				parseNumbers: true,
				callback: function(data, tabletop) {
					$.each(data,function(k,v){
						if(v.Active=='Yes'){
							activestories.push(v);
						}
					});
					makestories();
					storieslayer.addData(GeoJSON.parse(activestories, {Point: ['Latitude', 'Longitude']}));
				}
			});
			function makestories(){
				$('#stories').empty();
				var randomkeys=[];
				var i=0;
				do{
					var key=Math.floor(Math.random()*activestories.length);
					if(!randomkeys.includes(key)){
						randomkeys.push(key);
						i++;
					}
				}
				while(i<activestories.length);
				$.each(randomkeys,function(k,v){
					var thisstory=activestories[v];
					var dateinfo=[];
					if(thisstory['Date']!==''){
						dateinfo.push(thisstory['Date']);
					}else{
						dateinfo.push(thisstory['Time of Day']);
						dateinfo.push(thisstory['Time of Year']);
						dateinfo.push(thisstory['Year']);
					}
					var description=thisstory['Description'].substring(0, 300);
					$('#stories').append('<div class="column is-one-third-desktop is-full-mobile"><div class="message"><div class="message-body"><h5>'+thisstory['You were']+' - '+dateinfo.join(' ')+'</h5><h6>'+thisstory['Tell us who you are']+' &#183; '+thisstory['Timestamp']+'</h6><p>'+description+'</p><p><a href="https://yyt-sidewalks.github.io/sites/stories/?story='+thisstory['Identifier']+'">Read More</a></p></div></div></div>');
				});
			}
			var censusdata;
			var censusareas={};
			var prioritytoggle = false,layertoggles={},centretoggle=false;
			var gradient=["#168900","#2c7c00","#416f00","#576200","#6d5500","#834900","#993c00","#af2f00","#c42200","#da1500"];
			var alllayers={},prioritylayers={};

			var map = L.map('map',{zoomControl: false}).setView([47.5670, -52.7292], 13); //Initialize the map
			
			var formId = '1FAIpQLSe-QSvUtogBRyFaiLHxoOWoFVWYg-lE5SXpEduEjUUNQtrOkQ';
			var formLat = '761396806';
			var formLng = '376030242';
			var formText = '298764423';
			var formType = '1739376719';
			var formActive ='1860786605';
			var gsheet = '2PACX-1vQguHTF4WmXs4mMBPE6CgeYXNqI3S2GMgFW3nok9TmGqYIW_56kJGUBRO696CkLcOIhFqAPqB43rriA';
			var sharedgsheet ='https://docs.google.com/spreadsheets/d/1IYgFUTsPCthLhbRR7NLhpckAJLL4RleXrZ3AAMX9HMA/edit?usp=sharing';
		
			//Add a basemap
			var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			}).addTo(map);
			//Add Location Options - override the plugin default popup and circle
			new L.Control.Zoom({ position: 'bottomleft' }).addTo(map);			
			var marker, circle, lat, lng; //create variables used throughout the map
			
			//define icons
			var obtypes=['hydrant','pole','light','bridge','sign','traffic','other'];
			var typeicons={};
			$.each(obtypes,function(k,v){
				typeicons[v]= L.icon({
					iconUrl: 'images/icons/icon-'+v+'.png',
					iconSize: [40, 40], // size of the icon
					iconAnchor: [20, 44], // point of the icon which will correspond to marker's location
					popupAnchor:[-3, -76] // point from which the popup should open relative to the iconAnchor
				});
			});
			$.ajax({
				dataType: "json",
				url: "data/demographics.json",
				success: function(data) {
					censusdata=data;
					buildcensusdata();
				}
			});
			var censuslayer = new L.geoJson(null,{
				style: function(geoJsonFeature){
					return {fillColor: 'transparent', color:'none', weight: '0', fillOpacity: 0.2}
				},
				onEachFeature: function(feature, layer){
					censusareas[feature.properties.id] = layer;
				}
			});
			censuslayer.addTo(map);
			alllayers['census']=censuslayer;
			layertoggles['census']=false;
			$.ajax({
				dataType: "json",
				url: "data/censuszones.json",
				success: function(data) {
					$(data.features).each(function(key, data) {
						censuslayer.addData(data);
					});
				}
			});
			var schoolicon = new L.Icon({
				iconSize: [27, 27],
				iconAnchor: [13, 27],
				popupAnchor:  [1, -24],
				iconUrl: 'images/icons/school.png'
			});
			var schoollayer = new L.geoJson(null,{
				style: function(feature){
					if(feature.geometry.type === 'Polygon') {
						return {fillColor: '#cc9a10', color:'none', weight: '0', fillOpacity: 0.3}
					}
				},
				pointToLayer: function(feature, latlng) {
					if(feature.geometry.type === 'Point') {
						return L.marker(latlng, {icon: schoolicon});
					}
				}
			});
			schoollayer.addTo(map);
			alllayers['schools']=schoollayer;
			layertoggles['schools']=false;
			$.ajax({
				dataType: "json",
				url: "data/schools.json",
				success: function(data) {
					$(data.features).each(function(key, data) {
						schoollayer.addData(data);
					});
				}
			});
			var hospitalicon = new L.Icon({
				iconSize: [27, 27],
				iconAnchor: [13, 27],
				popupAnchor:  [1, -24],
				iconUrl: 'images/icons/hospital.png'
			});
			var hospitallayer = new L.geoJson(null,{
				style: function(feature){
					if(feature.geometry.type === 'Polygon') {
						return {fillColor: '#0a7ed1', color:'none', weight: '0', fillOpacity: 0.3}
					}
				},
				pointToLayer: function(feature, latlng) {
					if(feature.geometry.type === 'Point') {
						return L.marker(latlng, {icon: hospitalicon});
					}
				}
			});
			hospitallayer.addTo(map);
			alllayers['hospitals']=hospitallayer;
			layertoggles['hospitals']=false;
			$.ajax({
				dataType: "json",
				url: "data/hospitals.json",
				success: function(data) {
					$(data.features).each(function(key, data) {
						hospitallayer.addData(data);
					});
				}
			});
			var priorities={"school_zones":{"colour":"#f2ff00","size":"24","opacity":"0.6","legend": "School Zones"},"singleside":{"colour":"#3c00ff","size":"14","opacity":"0.4","legend": "Single Side Cleared"},"doubleside":{"colour":"#ff8000","size":"14","opacity":"0.4","legend": "Both Sizes Cleared"},"priority_3":{"colour":"#42ff65","size":"4","opacity":"1","legend": "Priority 3"},"priority_2":{"colour":"#02e2f2","size":"4","opacity":"1","legend": "Priority 2"},"priority_1":{"colour":"#ff4545","size":"4","opacity":"1","legend": "Priority 1"}};
			
			$.each(priorities,function(k,v){
				var thislayer = new L.geoJson(null,{
					style: function(){
						return {color: v.colour, opacity: v.opacity, weight: v.size}
					}
				});
				thislayer.addTo(map);
				$.ajax({
					dataType: "json",
					url: "data/"+k+".json",
					success: function(data) {
						$(data.features).each(function(key, data) {
							thislayer.addData(data);
						});
					}
				});
				alllayers[k]=thislayer;
				prioritylayers[k]=thislayer;
				layertoggles[k]=false;
			});
			$(function() {
				$('.datatoggle').click(function(){
					togglelayers($(this).data('layer'));
				});
				setTimeout(function() {
					$.each(censusdata,function(k,v){
						var rounded=Math.ceil(Math.round(v.percentages.walked.all*100)/10);
						var opacity=(Math.round(v.percentages.walked.all*10)/10)*1.75;
						censusareas[v.GeoUID].setStyle({fillColor:gradient[rounded],fillOpacity: opacity});
					});
					$('#showobstructions,#showschools,#showhospitals,#showstories').click();
				},1500);
			});
			function buildcensusdata(){
				censusdata.averages={};
				censusdata.totals={};
				censusdata.values={};
				censusdata.max={};
				censusdata.min={};
				censusdata.totals.afterTaxIncome=0;
				censusdata.values.afterTaxIncome=[];
				censusdata.max.afterTaxIncome=0;
				censusdata.min.afterTaxIncome=0;
				censusdata.values.density=[];
				censusdata.max.density=0;
				censusdata.min.density=0;
				censusdata.ranges={};
				censusdata.ranges.afterTaxIncome=[0];
				censusdata.ranges.density=[0];
				censusdata.tiers={};
				censusdata.tiers.afterTaxIncome=0;
				censusdata.tiers.density=0;
				var hasAfterTaxIncome=0;
				$.each(censusdata,function(k,v){
					censusdata[k].density=Math.ceil(parseInt(v.Population)*(1/parseFloat(v['Area (sq km)'])));
					censusdata.values.density.push(censusdata[k].density);
					censusdata[k].percentages={};
					censusdata[k].percentages.walked={};
					if(parseInt(v.Data.v_CA16_5792.value)){
						censusdata[k].percentages.walked.all=parseInt(v.Data.v_CA16_5804.value)/parseInt(v.Data.v_CA16_5792.value);
					}else{
						censusdata[k].percentages.walked.all=0;
					}
					if(parseInt(v.Data.v_CA16_5794.value)){
						censusdata[k].percentages.walked.female=parseInt(v.Data.v_CA16_5806.value)/parseInt(v.Data.v_CA16_5794.value);
					}else{
						censusdata[k].percentages.walked.female=0;
					}
					if(parseInt(v.Data.v_CA16_5793.value)){
						censusdata[k].percentages.walked.male=parseInt(v.Data.v_CA16_5805.value)/parseInt(v.Data.v_CA16_5793.value);
					}else{
						censusdata[k].percentages.walked.male=0;
					}
					censusdata[k].percentages.transit={};
					if(parseInt(v.Data.v_CA16_5792.value)){
						censusdata[k].percentages.transit.all=parseInt(v.Data.v_CA16_5801.value)/parseInt(v.Data.v_CA16_5792.value);
					}else{
						censusdata[k].percentages.transit.all=0;
					}
					if(parseInt(v.Data.v_CA16_5794.value)){
						censusdata[k].percentages.transit.female=parseInt(v.Data.v_CA16_5803.value)/parseInt(v.Data.v_CA16_5794.value);
					}else{
						censusdata[k].percentages.transit.female=0;
					}
					if(parseInt(v.Data.v_CA16_5793.value)){
						censusdata[k].percentages.transit.male=parseInt(v.Data.v_CA16_5802.value)/parseInt(v.Data.v_CA16_5793.value);
					}else{
						censusdata[k].percentages.transit.male=0;
					}
					if(parseInt(v.Data.v_CA16_4963.value)!==false){
						censusdata.totals.afterTaxIncome=censusdata.totals.afterTaxIncome+parseInt(v.Data.v_CA16_4963.value);
						hasAfterTaxIncome++;
						censusdata.values.afterTaxIncome.push(parseInt(v.Data.v_CA16_4963.value));
					}
				});
				censusdata.averages.afterTaxIncome=Math.ceil(censusdata.totals.afterTaxIncome/hasAfterTaxIncome);
				censusdata.max.afterTaxIncome=Math.max.apply(Math,censusdata.values.afterTaxIncome);
				censusdata.min.afterTaxIncome=Math.min.apply(Math,censusdata.values.afterTaxIncome);
				censusdata.tiers.afterTaxIncome=Math.ceil(censusdata.max.afterTaxIncome/gradient.length);
				censusdata.max.density=Math.max.apply(Math,censusdata.values.density);
				censusdata.min.density=Math.min.apply(Math,censusdata.values.density);
				censusdata.tiers.density=Math.ceil(censusdata.max.density/gradient.length);
				//calculate tiers for gradients
				$.each(gradient,function(k,v){
					if(k){
						var lastkey=k-1;
						censusdata.ranges.afterTaxIncome.push(censusdata.tiers.afterTaxIncome+censusdata.ranges.afterTaxIncome[lastkey]);
						censusdata.ranges.density.push(censusdata.tiers.density+censusdata.ranges.density[lastkey]);
					}
				});
			}
			
			function togglelayers(l) {
				if(l=="priorities"){
					if(!prioritytoggle){
						$.each(layertoggles,function(k,v){
							if(!v && k!='census' && k!='schools' && k!='hospitals' && k!='obstructions' && k!='stories'){
								map.removeLayer(prioritylayers[k]);
								layertoggles[k] = !layertoggles[k];
							}
						});
						$('.datatoggle[data-layer="'+l+'"').addClass('showndata');
					} else {
						$.each(layertoggles,function(k,v){
							if(v && k!='census' && k!='schools' && k!='hospitals' && k!='obstructions' && k!='stories'){
								map.addLayer(prioritylayers[k]);
								layertoggles[k] = !layertoggles[k];
							}
						});
						$('.datatoggle[data-layer="'+l+'"').removeClass('showndata');
					}
					prioritytoggle = !prioritytoggle;
				}else{
					if(!layertoggles[l]){
						map.removeLayer(alllayers[l]);
						$('.datatoggle[data-layer="'+l+'"').addClass('showndata');
					} else {
						map.addLayer(alllayers[l]);
						$('.datatoggle[data-layer="'+l+'"').removeClass('showndata');
					}
					layertoggles[l] = !layertoggles[l];
				}
			}
		
			function geticontype(t){
				var it;
				switch(t){
					case "Fire Hydrant":
						it="hydrant";
					break;
					case "Telephone or Power Pole (pole and wires)":
						it="pole";
					break;
					case "Street Light":
						it="light";
					break;
					case "Bridge with Narrow sidewalks":
						it="bridge";
					break;
					case "Street Sign (parking, stop sign, etc)":
						it="sign";
					break;
					case "Traffic Light":
						it="traffic";
					break;
					case "Other Obstruction":
						it="other";
					break;
				}
				return it;
			}
			//Add form response points
			//Add an empty geojson layer for the google sheet points and create the popup
			var obstructionslayer = new L.geoJson(null, {
				pointToLayer: function(feature, latlng) {
					var thistype=geticontype(feature.properties.Type);
					return L.marker(latlng, {icon: typeicons[thistype]});
				},
				onEachFeature: function(feature, layer) {
					var popupcontent='<h6>'+feature.properties.Identifier+'</h6>';
					if(feature.properties.Description){
						popupcontent=popupcontent+'<p>'+feature.properties.Description+'</p>';
					}
					obstructionslayer.bindPopup(popupcontent);
					$('a.leaflet-popup-close-button').html('<i class="fas fa-times"></i>');
				}
			});
		
			//Grab the google sheet data using tabletop - published to the web not just shared - and use geojson.min.js to convert into proper geojson format
			obstructionslayer.addTo(map);
			alllayers['obstructions']=obstructionslayer;
			layertoggles['obstructions']=false;
			var tabletop = Tabletop.init( {
				key: sharedgsheet,
				simpleSheet: true,
				parseNumbers: true,
				callback: function(data, tabletop) {
				var activedata=[];
				$.each(data,function(k,v){
					if(v.Active=='Yes'){
						activedata.push(v);
					}
				});
				var gpsData = GeoJSON.parse(activedata, {Point: ['Latitude', 'Longitude']});
				//add that data to the geojson layer created earlier
				obstructionslayer.addData(gpsData);
				},
			});

			var storieslayer = new L.geoJson(null, {
				pointToLayer: function(feature, latlng) {
					var thisicon=L.icon({
						iconUrl: 'images/icons/story.png',
						iconSize: [40, 40], // size of the icon
						iconAnchor: [20, 44], // point of the icon which will correspond to marker's location
						popupAnchor:[-3, -76] // point from which the popup should open relative to the iconAnchor
					});
					return L.marker(latlng, {icon: thisicon});
				},
				onEachFeature: function(feature, layer) {
					var popupcontent='<h6>'+feature.properties.Identifier+'</h6>';
					if(feature.properties.Description){
						popupcontent=popupcontent+'<p>'+feature.properties.Description+'</p>';
					}
					storieslayer.bindPopup(popupcontent);
					$('a.leaflet-popup-close-button').html('<i class="fas fa-times"></i>');
				}
			});
		
			//Grab the google sheet data using tabletop - published to the web not just shared - and use geojson.min.js to convert into proper geojson format
			storieslayer.addTo(map);
			alllayers['stories']=storieslayer;
			layertoggles['stories']=false;
			//add that data to the geojson layer created earlier
			
		</script>
		<link rel="stylesheet" href="css/leaflet.css">
	</body>
</html>
